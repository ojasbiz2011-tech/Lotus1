<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Passive Income</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src='//libtl.com/sdk.js' data-zone='10572322' data-sdk='show_10572322'></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #0f0f0f;
            --text-color: #ffffff;
            --accent-color: #00ffa3; /* Neon Green */
            --secondary-text: #888;
            --card-bg: #1a1a1a;
            --bar-bg: #333;
            --transition-speed: 0.6s;
            --easing: cubic-bezier(0.22, 1, 0.36, 1); /* Fluid easing */
        }

        [data-theme="light"] {
            --bg-color: #f4f4f4;
            --text-color: #111;
            --accent-color: #00b874;
            --secondary-text: #666;
            --card-bg: #fff;
            --bar-bg: #e0e0e0;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            transition: background-color var(--transition-speed) var(--easing), color var(--transition-speed);
            display: flex; justify-content: center; align-items: center;
            height: 100vh;
        }

        /* --- UI CONTAINER --- */
        #app-container {
            width: 100%; height: 100%;
            position: relative;
            overflow: hidden;
        }

        /* --- SCREENS --- */
        .screen {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 20px;
            opacity: 0; pointer-events: none;
            transition: opacity 0.8s var(--easing), transform 0.8s var(--easing);
        }

        .screen.active {
            opacity: 1; pointer-events: auto;
            transform: scale(1);
        }

        .screen.exit {
            opacity: 0; transform: scale(0.95);
        }

        /* --- HOME SCREEN ELEMENTS --- */
        .mode-toggle {
            position: absolute; top: 20px; right: 20px;
            font-size: 24px; cursor: pointer;
            opacity: 0.5; transition: opacity 0.3s;
        }
        .mode-toggle:hover { opacity: 1; }

        h1 {
            font-weight: 800; font-size: 42px; margin-bottom: 5px;
            letter-spacing: -1px;
            background: linear-gradient(135deg, var(--text-color), var(--secondary-text));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: slideUp 1s var(--easing) forwards;
        }

        .subtitle {
            font-size: 14px; color: var(--secondary-text); margin-bottom: 20px;
            font-weight: 300; letter-spacing: 1px;
            animation: slideUp 1.1s var(--easing) forwards;
        }

        /* Progress Bar */
        .progress-container {
            width: 100%; max-width: 280px;
            margin-bottom: 40px;
            animation: slideUp 1.2s var(--easing) forwards;
        }
        
        .progress-track {
            height: 4px; width: 100%;
            background: var(--bar-bg);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%; width: 0%;
            background: var(--accent-color);
            border-radius: 10px;
            transition: width 1s var(--easing);
            box-shadow: 0 0 10px var(--accent-color);
        }

        /* Start Button */
        .btn-start {
            background: var(--text-color);
            color: var(--bg-color);
            border: none;
            padding: 18px 50px;
            font-size: 18px; font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            animation: slideUp 1.3s var(--easing) forwards;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .btn-start:active { transform: scale(0.96); }

        .reward-info {
            margin-top: 30px;
            color: var(--accent-color);
            font-size: 12px;
            text-align: center;
            max-width: 250px;
            line-height: 1.5;
            animation: fadeIn 2s ease forwards;
        }

        /* --- GAME SCREEN --- */
        #game-wrapper {
            width: 100%; height: 100%;
            max-width: 450px;
            position: relative;
            background: #fff; /* Game needs light bg or transparent */
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }
        
        canvas { display: block; width: 100%; height: 100%; }

        /* Game Over Modal */
        #game-over-ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.5s;
            color: #fff;
        }
        #game-over-ui.visible { opacity: 1; pointer-events: auto; }

        .go-title { font-size: 40px; font-weight: 800; color: #ff4757; margin-bottom: 10px; }
        .go-score { font-size: 20px; margin-bottom: 30px; color: #fff; }
        
        .btn-revive {
            background: var(--accent-color); color: #000;
            padding: 15px 30px; border-radius: 12px;
            font-weight: bold; border: none; cursor: pointer;
            margin-bottom: 10px; width: 200px;
        }
        .btn-home {
            background: transparent; color: #888;
            border: 2px solid #555; padding: 12px;
            border-radius: 12px; font-weight: bold; cursor: pointer;
            width: 200px;
        }

        /* ANIMATIONS */
        @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    </style>
</head>
<body data-theme="dark">

<div id="app-container">

    <div id="screen-home" class="screen active">
        <div class="mode-toggle" onclick="toggleTheme()">‚óë</div>

        <h1>Passive Income</h1>
        <div class="subtitle">
            <span id="ads-count">0</span>/100 ads watched
        </div>

        <div class="progress-container">
            <div class="progress-track">
                <div class="progress-fill" id="progress-bar"></div>
            </div>
        </div>

        <button class="btn-start" onclick="transitionToGame()">Start ‚û°Ô∏è</button>

        <div class="reward-info">
            * Person with most points today will be awarded ‚Çπ50
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div id="game-wrapper">
            <canvas id="canvas"></canvas>
            
            <div id="game-over-ui">
                <div class="go-title">GAME OVER</div>
                <div class="go-score">Score: <span id="final-score">0</span></div>
                <button class="btn-revive" onclick="watchAdAndRevive()">üì∫ Watch Ad & Revive</button>
                <button class="btn-home" onclick="goHome()">üè† Home</button>
            </div>
        </div>
    </div>

</div>

<div style="display:none;">
    <img id="sprite" src="https://i.imgur.com/2WEhF.png" crossorigin="anonymous">
</div>

<script>
    // --- 1. APP STATE & THEME ---
    let state = {
        adsWatched: 0,
        theme: 'dark',
        userId: 'Guest'
    };

    // Load from LocalStorage
    const savedData = localStorage.getItem('passiveIncomeData');
    if (savedData) {
        state = { ...state, ...JSON.parse(savedData) };
        updateHomeUI();
    }

    // Telegram ID
    if (window.Telegram?.WebApp) {
        const user = window.Telegram.WebApp.initDataUnsafe.user;
        if (user) state.userId = user.id;
    }

    function toggleTheme() {
        state.theme = state.theme === 'dark' ? 'light' : 'dark';
        document.body.setAttribute('data-theme', state.theme);
        saveData();
    }
    // Set initial theme
    document.body.setAttribute('data-theme', state.theme);

    function updateHomeUI() {
        document.getElementById('ads-count').innerText = state.adsWatched;
        let pct = (state.adsWatched / 100) * 100;
        if (pct > 100) pct = 100;
        document.getElementById('progress-bar').style.width = pct + "%";
    }

    function saveData() {
        localStorage.setItem('passiveIncomeData', JSON.stringify(state));
        // Mock Server Sync
        try {
            // Replace with your actual server.py endpoint
            // fetch('https://your-server.com/api/sync', { method: 'POST', body: JSON.stringify(state) });
        } catch(e) {}
    }

    // --- 2. TRANSITIONS ---
    function transitionToGame() {
        const home = document.getElementById('screen-home');
        const game = document.getElementById('screen-game');
        
        home.classList.add('exit');
        home.classList.remove('active');

        setTimeout(() => {
            game.classList.add('active');
            initGame(); // Start the game engine
        }, 600);
    }

    function goHome() {
        const home = document.getElementById('screen-home');
        const game = document.getElementById('screen-game');
        const ui = document.getElementById('game-over-ui');

        ui.classList.remove('visible');
        game.classList.remove('active');
        
        updateHomeUI(); // Refresh numbers
        
        setTimeout(() => {
            home.classList.remove('exit');
            home.classList.add('active');
        }, 100);
        
        player.isDead = true; // Ensure game stops
    }

    // --- 3. AD INTEGRATION ---
    function watchAdAndRevive() {
        if (typeof show_10572322 === 'function') {
            show_10572322().then(() => {
                // Success
                state.adsWatched++;
                saveData();
                reviveGame();
                alert('You have seen an ad! +1 to Progress');
            }).catch(e => {
                // Error / AdBlock Fallback
                console.log("Ad Error", e);
                state.adsWatched++; // Give credit anyway for testing
                saveData();
                reviveGame();
            });
        } else {
            console.warn("Monetag SDK not ready. Reviving for testing.");
            state.adsWatched++;
            saveData();
            reviveGame();
        }
    }

    // --- 4. GAME ENGINE (DOODLE JUMP) ---
    // Minified logic adapted for this UI
    
    var canvas = document.getElementById('canvas'),
        ctx = canvas.getContext('2d');
    var width = 360, height = 640;
    
    // Resize handling
    function resizeCanvas() {
        const wrapper = document.getElementById('game-wrapper');
        canvas.width = wrapper.clientWidth;
        canvas.height = wrapper.clientHeight;
        width = canvas.width;
        height = canvas.height;
    }
    window.addEventListener('resize', resizeCanvas);

    var platforms = [], image = document.getElementById("sprite"),
        player, platformCount = 10, position = 0, gravity = 0.2,
        animloop, flag = 0, broken = 0, dir, score = 0, firstRun = true;

    var Base = function() {
        this.height = 5; this.width = width;
        this.cx = 0; this.cy = 614; this.cwidth = 100; this.cheight = 5;
        this.x = 0; this.y = height - this.height;
        this.draw = function() { try { ctx.drawImage(image, this.cx, this.cy, this.cwidth, this.cheight, this.x, this.y, this.width, this.height); } catch (e) {} };
    };
    var base = new Base();

    var Player = function() {
        this.vy = 11; this.vx = 0;
        this.isMovingLeft = false; this.isMovingRight = false;
        this.isDead = false;
        this.width = 55; this.height = 40;
        this.cx = 0; this.cy = 0; this.cwidth = 110; this.cheight = 80;
        this.dir = "left";
        this.x = width / 2 - this.width / 2; this.y = height;
        this.draw = function() {
            try {
                if (this.dir == "right") this.cy = 121; else if (this.dir == "left") this.cy = 201;
                ctx.drawImage(image, this.cx, this.cy, this.cwidth, this.cheight, this.x, this.y, this.width, this.height);
            } catch (e) {}
        };
        this.jump = function() { this.vy = -8; };
    };
    player = new Player();

    function Platform() {
        this.width = 70; this.height = 17;
        this.x = Math.random() * (width - this.width);
        this.y = position;
        position += (height / platformCount);
        this.flag = 0; this.state = 0;
        this.cx = 0; this.cy = 0; this.cwidth = 105; this.cheight = 31;
        this.draw = function() {
            try {
                if (this.type == 1) this.cy = 0; else if (this.type == 2) this.cy = 61;
                ctx.drawImage(image, this.cx, this.cy, this.cwidth, this.cheight, this.x, this.y, this.width, this.height);
            } catch (e) {}
        };
        this.type = 1; // Simplify types for this version
        this.vx = 1;
    }

    function initGame() {
        resizeCanvas();
        resetVars();
        animloop();
    }

    function resetVars() {
        player = new Player();
        base = new Base();
        platforms = [];
        position = 0; score = 0;
        for (var i = 0; i < platformCount; i++) platforms.push(new Platform());
        document.getElementById('game-over-ui').classList.remove('visible');
    }

    function reviveGame() {
        // Reset player to safe spot, keep score
        player.y = height / 2;
        player.vy = 0;
        player.x = width / 2;
        player.isDead = false;
        // Move base under player
        base.y = height + 100; // Hide base
        // Clear nearby platforms
        platforms.forEach(p => { if (p.y > player.y && p.y < player.y + 200) p.y = -100; });
        platforms.push(new Platform()); platforms[platforms.length-1].y = player.y + 100; platforms[platforms.length-1].x = player.x;

        document.getElementById('game-over-ui').classList.remove('visible');
        animloop();
    }

    function gameOver() {
        player.isDead = true;
        document.getElementById('final-score').innerText = score;
        document.getElementById('game-over-ui').classList.add('visible');
    }

    function update() {
        ctx.clearRect(0, 0, width, height);
        
        // Input Physics
        if (player.isMovingLeft) { player.x += player.vx; player.vx -= 0.15; } 
        else { player.x += player.vx; if (player.vx < 0) player.vx += 0.1; }
        if (player.isMovingRight) { player.x += player.vx; player.vx += 0.15; } 
        else { player.x += player.vx; if (player.vx > 0) player.vx -= 0.1; }

        // Wall Loop
        if (player.x > width) player.x = 0 - player.width;
        else if (player.x < 0 - player.width) player.x = width;

        // Gravity / Jump
        if ((player.y + player.height) > base.y && base.y < height) player.jump();
        
        // Death
        if (player.y > height && !player.isDead) { gameOver(); return; }

        // Camera Scroll
        if (player.y >= (height / 2) - (player.height / 2)) {
            player.y += player.vy;
            player.vy += gravity;
        } else {
            platforms.forEach(function(p, i) {
                if (player.vy < 0) p.y -= player.vy;
                if (p.y > height) {
                    platforms[i] = new Platform();
                    platforms[i].y = p.y - height;
                }
            });
            base.y -= player.vy;
            player.vy += gravity;
            if (player.vy >= 0) { player.y += player.vy; player.vy += gravity; }
            score++;
        }

        // Draw
        platforms.forEach(p => p.draw());
        player.draw();
        base.draw();

        // Platform Collision
        platforms.forEach(function(p) {
            if (player.vy > 0 && 
               (player.x + 15 < p.x + p.width) && 
               (player.x + player.width - 15 > p.x) && 
               (player.y + player.height > p.y) && 
               (player.y + player.height < p.y + p.height)) {
                player.jump();
            }
        });
    }

    animloop = function() {
        if (!player.isDead && document.getElementById('screen-game').classList.contains('active')) {
            update();
            requestAnimationFrame(animloop);
        }
    };

    // CONTROLS (Touch + Key)
    document.onkeydown = function(e) {
        if (e.keyCode == 37) { player.dir = "left"; player.isMovingLeft = true; }
        else if (e.keyCode == 39) { player.dir = "right"; player.isMovingRight = true; }
    };
    document.onkeyup = function(e) { player.isMovingLeft = false; player.isMovingRight = false; };
    
    // Touch
    canvas.addEventListener('touchstart', function(e) {
        e.preventDefault();
        var rect = canvas.getBoundingClientRect();
        var x = e.touches[0].clientX - rect.left;
        if (x < width / 2) { player.dir = "left"; player.isMovingLeft = true; }
        else { player.dir = "right"; player.isMovingRight = true; }
    });
    canvas.addEventListener('touchend', function() { player.isMovingLeft = false; player.isMovingRight = false; });

</script>
</body>
</html>
