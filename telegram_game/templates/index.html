<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Floppy Bird Challenge</title>

    <script src='//libtl.com/sdk.js' data-zone='10572322' data-sdk='show_10572322'></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

    <style>
        body { 
            margin: 0; padding: 0; 
            background-color: #70c5ce; 
            font-family: 'Press Start 2P', cursive; 
            overflow: hidden; 
            user-select: none; 
            touch-action: none;
        }

        /* UTILS */
        .hidden { display: none !important; }
        
        /* SCREENS */
        .screen { 
            width: 100%; height: 100vh; 
            position: absolute; top: 0; left: 0; 
            display: flex; flex-direction: column; align-items: center; 
            z-index: 10;
        }

        /* HOME SCREEN */
        #screen-home {
            background: linear-gradient(#70c5ce, #fff); /* Fallback */
            justify-content: center;
        }
        
        .logo {
            font-size: 30px; color: #fff; 
            text-shadow: 4px 4px 0 #000;
            margin-bottom: 20px; text-align: center;
            line-height: 1.5;
        }

        .score-board {
            background: #ded895;
            border: 4px solid #543847;
            padding: 15px;
            text-align: center;
            margin-bottom: 30px;
            width: 80%;
            border-radius: 4px;
            box-shadow: 0 6px 0 rgba(0,0,0,0.2);
        }
        .score-label { color: #e58d25; font-size: 10px; margin-bottom: 5px; }
        .score-val { color: #fff; font-size: 20px; text-shadow: 2px 2px 0 #000; }

        /* BUTTONS */
        .btn {
            background: #e6522c; /* Reddish Orange */
            border: 4px solid #fff;
            color: #fff;
            padding: 15px 20px;
            font-family: 'Press Start 2P', cursive;
            font-size: 14px;
            cursor: pointer;
            margin: 10px;
            box-shadow: 4px 4px 0 #000;
            text-shadow: 2px 2px 0 #000;
            transition: transform 0.1s;
        }
        .btn:active { transform: translate(4px, 4px); box-shadow: 0 0 0 #000; }
        .btn-green { background: #55b62b; }
        .btn-blue { background: #3b8ad9; }

        /* GAME OVER OVERLAY */
        #game-over-modal {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #ded895;
            border: 4px solid #543847;
            padding: 20px;
            text-align: center;
            display: none;
            z-index: 20;
            width: 80%;
        }

        /* SCORE HUD */
        #hud-score {
            position: absolute; top: 10%; width: 100%;
            text-align: center; font-size: 40px; color: white;
            text-shadow: 4px 4px 0 #000;
            z-index: 5; pointer-events: none;
        }
        
        /* LOGS */
        .logs-box {
            font-size: 8px; color: #543847; 
            margin-top: 10px; height: 50px; overflow-y: scroll;
            width: 80%; background: rgba(255,255,255,0.3); padding: 5px;
        }

        canvas { 
            display: block; width: 100%; height: 100%; 
            image-rendering: pixelated; 
        }
    </style>
</head>
<body>

    <div id="screen-home" class="screen">
        <div class="logo">FLOPPY<br>BIRD</div>
        
        <div class="score-board">
            <div class="score-label">WEEKLY BEST</div>
            <div class="score-val" id="best-score">0</div>
        </div>

        <button class="btn btn-green" onclick="startGame()">‚ñ∂ START GAME</button>
        <button class="btn btn-blue" onclick="loadLeaderboard()">üèÜ RANKING</button>
        
        <div class="logs-box" id="recent-logs">Loading logs...</div>
    </div>

    <div id="screen-game" class="screen hidden">
        <div id="hud-score">0</div>
        <canvas id="gameCanvas"></canvas>
        
        <div id="game-over-modal">
            <h2 style="color: #e6522c; margin-top:0; text-shadow: 2px 2px 0 #000;">GAME OVER</h2>
            <p>SCORE: <span id="final-score">0</span></p>
            
            <button id="btn-revive" class="btn btn-blue" onclick="startReviveChain()">
                üì∫ REVIVE (0/3)
            </button>
            <br>
            <button class="btn" onclick="quitGame()">‚ùå QUIT</button>
        </div>
    </div>

<script>
// --- CONFIGURATION ---
const GRAVITY = 0.25;
const JUMP = -4.6;
const PIPE_SPEED = 2;
const PIPE_SPAWN_RATE = 120; // Frames
const PIPE_GAP = 100; // Gap size

// --- ASSETS ---
const bgImage = new Image();
bgImage.src = 'flappy_bird_app_bg_only.png'; 
// Note: If image fails, we fallback to blue color

// --- AUDIO (Synthesized) ---
const AudioContext = window.AudioContext || window.webkitAudioContext;
let audioCtx;

function initAudio() {
    if (!audioCtx) audioCtx = new AudioContext();
    if (audioCtx.state === 'suspended') audioCtx.resume();
}

function playSound(type) {
    if (!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);

    if (type === 'jump') {
        osc.type = 'square';
        osc.frequency.setValueAtTime(150, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    } else if (type === 'die') {
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(200, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.3);
        gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
        osc.start(); osc.stop(audioCtx.currentTime + 0.3);
    } else if (type === 'score') {
        osc.type = 'sine';
        osc.frequency.setValueAtTime(1000, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    }
}

// --- GAME STATE ---
let canvas = document.getElementById('gameCanvas');
let ctx = canvas.getContext('2d');
let frames = 0;
let score = 0;
let bestScore = 0;
let gameState = 'START'; // START, PLAYING, GAMEOVER
let adsWatched = 0; // For revive logic

let bird = { x: 50, y: 150, w: 34, h: 24, velocity: 0, frame: 0 };
let pipes = [];

// --- RESIZE ---
function resize() {
    canvas.width = 320; // Internal resolution (retro feel)
    canvas.height = 480;
    // CSS handles the stretching to full screen
}
resize();

// --- GAME LOOP ---
function loop() {
    update();
    draw();
    if (gameState !== 'QUIT') requestAnimationFrame(loop);
}

function update() {
    if (gameState !== 'PLAYING') return;

    frames++;

    // Bird Physics
    bird.velocity += GRAVITY;
    bird.y += bird.velocity;

    // Ground Collision
    let groundY = canvas.height - 112; // Approximation of ground height in BG
    if (bird.y + bird.h >= groundY) {
        bird.y = groundY - bird.h;
        gameOver();
    }

    // Pipe Logic
    if (frames % PIPE_SPAWN_RATE === 0) {
        let topH = Math.random() * (canvas.height - 200) + 20;
        pipes.push({
            x: canvas.width,
            y: topH, // Height of bottom edge of top pipe
            passed: false
        });
    }

    for (let i = 0; i < pipes.length; i++) {
        let p = pipes[i];
        p.x -= PIPE_SPEED;

        // Collision Check
        // Top Pipe Rect: {x: p.x, y: 0, w: 52, h: p.y}
        // Bottom Pipe Rect: {x: p.x, y: p.y + PIPE_GAP, w: 52, h: canvas.height}
        
        let birdLeft = bird.x + 2; // Hitbox adjustment
        let birdRight = bird.x + bird.w - 2;
        let birdTop = bird.y + 2;
        let birdBottom = bird.y + bird.h - 2;

        let pipeLeft = p.x;
        let pipeRight = p.x + 52;

        if (birdRight > pipeLeft && birdLeft < pipeRight) {
            // Inside pipe horizontal area
            if (birdTop < p.y || birdBottom > p.y + PIPE_GAP) {
                gameOver();
            }
        }

        // Score
        if (p.x + 52 < bird.x && !p.passed) {
            score++;
            p.passed = true;
            playSound('score');
            document.getElementById('hud-score').innerText = score;
        }

        // Remove old pipes
        if (p.x + 52 < 0) {
            pipes.shift();
            i--;
        }
    }
}

function draw() {
    // 1. Background
    if (bgImage.complete) {
        ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);
    } else {
        ctx.fillStyle = "#70c5ce";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        // Draw basic ground
        ctx.fillStyle = "#ded895";
        ctx.fillRect(0, canvas.height - 112, canvas.width, 112);
    }

    // 2. Pipes
    for (let p of pipes) {
        drawPipe(p.x, p.y);
    }

    // 3. Bird
    drawBird(bird.x, bird.y, bird.velocity);
}

// --- DRAWING HELPERS (Pixel Art Code) ---
function drawBird(x, y, vel) {
    ctx.save();
    ctx.translate(x + bird.w/2, y + bird.h/2);
    let rotation = Math.min(Math.PI / 4, Math.max(-Math.PI / 4, (vel * 0.1)));
    ctx.rotate(rotation);
    
    // Pixel Art Bird (Yellow body, white eye, orange beak)
    let w = bird.w, h = bird.h;
    
    // Outline
    ctx.fillStyle = "#543847"; // Dark stroke
    ctx.fillRect(-w/2, -h/2, w, h);
    
    // Body
    ctx.fillStyle = "#e9fc00"; // Yellow
    ctx.fillRect(-w/2 + 2, -h/2 + 2, w - 4, h - 4);
    
    // Eye
    ctx.fillStyle = "#fff";
    ctx.fillRect(4, -8, 10, 10);
    ctx.fillStyle = "#000"; // Pupil
    ctx.fillRect(10, -6, 2, 2);
    
    // Beak
    ctx.fillStyle = "#e6522c"; // Orange
    ctx.fillRect(6, 2, 12, 6);
    
    // Wing
    ctx.fillStyle = "#fff";
    ctx.fillRect(-10, 0, 12, 6);

    ctx.restore();
}

function drawPipe(x, topH) {
    let w = 52;
    let gap = PIPE_GAP;
    
    ctx.fillStyle = "#73bf2e"; // Light Green
    ctx.strokeStyle = "#543847"; // Dark Outline
    ctx.lineWidth = 2;

    // Top Pipe
    ctx.fillRect(x, 0, w, topH);
    ctx.strokeRect(x, -2, w, topH); // Main body
    ctx.fillRect(x - 2, topH - 24, w + 4, 24); // Cap
    ctx.strokeRect(x - 2, topH - 24, w + 4, 24); // Cap outline

    // Bottom Pipe
    let botY = topH + gap;
    let botH = canvas.height - botY - 112; // Stop at ground
    ctx.fillRect(x, botY, w, botH);
    ctx.strokeRect(x, botY, w, botH + 2);
    ctx.fillRect(x - 2, botY, w + 4, 24); // Cap
    ctx.strokeRect(x - 2, botY, w + 4, 24); // Cap outline
}

// --- CONTROLS ---
function jump() {
    if (gameState === 'PLAYING') {
        bird.velocity = JUMP;
        playSound('jump');
    }
}
window.addEventListener('mousedown', jump);
window.addEventListener('touchstart', (e) => { e.preventDefault(); jump(); });

// --- GAME LOGIC FLOW ---
function startGame() {
    initAudio();
    document.getElementById('screen-home').classList.add('hidden');
    document.getElementById('screen-game').classList.remove('hidden');
    resetGame();
    gameState = 'PLAYING';
    loop();
}

function resetGame() {
    bird.y = 150;
    bird.velocity = 0;
    pipes = [];
    score = 0;
    frames = 0;
    document.getElementById('hud-score').innerText = '0';
    document.getElementById('game-over-modal').style.display = 'none';
    adsWatched = 0;
    updateReviveBtn();
}

function gameOver() {
    gameState = 'GAMEOVER';
    playSound('die');
    document.getElementById('final-score').innerText = score;
    document.getElementById('game-over-modal').style.display = 'block';
    
    // Save Score
    saveScore(score);
}

function quitGame() {
    document.getElementById('screen-game').classList.add('hidden');
    document.getElementById('screen-home').classList.remove('hidden');
    loadUserData(); // Refresh logs
}

// --- REVIVE LOGIC (3 ADS) ---
function updateReviveBtn() {
    let btn = document.getElementById('btn-revive');
    if (adsWatched >= 3) {
        btn.innerText = "‚ù§Ô∏è REVIVE NOW!";
        btn.classList.add('btn-green');
        btn.classList.remove('btn-blue');
    } else {
        btn.innerText = `üì∫ REVIVE (${adsWatched}/3)`;
        btn.classList.remove('btn-green');
        btn.classList.add('btn-blue');
    }
}

function startReviveChain() {
    if (adsWatched >= 3) {
        // ACTUALLY REVIVE
        gameState = 'PLAYING';
        bird.y = 150; // Reset position safely
        bird.velocity = 0;
        pipes = []; // Clear pipes for safe start
        document.getElementById('game-over-modal').style.display = 'none';
        playSound('jump');
        return;
    }

    // WATCH AD
    if (typeof show_10572322 === 'function') {
        show_10572322().then(() => {
            adsWatched++;
            updateReviveBtn();
            if(adsWatched < 3) {
                alert(`Ad ${adsWatched}/3 Complete. Watch ${3-adsWatched} more to revive.`);
            }
        }).catch(e => {
            console.log("Ad Error", e);
            // Fallback for testing (remove in production)
            adsWatched++; 
            updateReviveBtn();
        });
    } else {
        alert("Ad script not loaded.");
    }
}

// --- BACKEND SIMULATION ---
async function saveScore(s) {
    if (s > bestScore) bestScore = s;
    try {
        const userId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || 12345;
        // POST score to server
        await fetch('/api/score/submit', { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ user_id: userId, score: s }) 
        });
    } catch(e) {}
}

async function loadUserData() {
    try {
        const userId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id || 12345;
        let res = await fetch(`/api/user/${userId}`); // Assume API returns weekly high score
        if (res.ok) {
            let d = await res.json();
            document.getElementById('best-score').innerText = d.weekly_best || 0;
            bestScore = d.weekly_best || 0;
            
            // Logs
            let html = "";
            if(d.logs) d.logs.forEach(l => html += `<div>Running: ${l} pipes</div>`);
            document.getElementById('recent-logs').innerHTML = html || "No runs this week.";
        }
    } catch(e) {
        document.getElementById('recent-logs').innerHTML = "Offline Mode";
    }
}

// Init
loadUserData();

</script>
</body>
</html>
